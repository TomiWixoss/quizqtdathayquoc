/**
 * Script Ä‘á»ƒ generate file TypeScript chá»©a ná»™i dung cÃ¡c chÆ°Æ¡ng QTDA
 * Cháº¡y: node scripts/generate-qtda-chapters.cjs
 */

const fs = require("fs");
const path = require("path");

const QTDA_DATA_DIR = path.join(__dirname, "..", "QTDA_DATA");
const OUTPUT_FILE = path.join(
  __dirname,
  "..",
  "src",
  "data",
  "qtda-chapters.ts"
);

// Äá»c táº¥t cáº£ file C*.txt trong QTDA_DATA
function readChapterFiles() {
  const chapters = [];

  for (let i = 1; i <= 14; i++) {
    const filePath = path.join(QTDA_DATA_DIR, `C${i}.txt`);

    if (fs.existsSync(filePath)) {
      const content = fs.readFileSync(filePath, "utf-8");

      // Láº¥y tÃªn chÆ°Æ¡ng tá»« dÃ²ng Ä‘áº§u tiÃªn
      const firstLine = content.split("\n")[0].trim();
      const chapterName = firstLine.replace(/^ChÆ°Æ¡ng\s*\d+\.\s*/i, "").trim();

      chapters.push({
        id: i,
        name: `ChÆ°Æ¡ng ${i}: ${chapterName}`,
        shortName: chapterName,
        content: content,
      });

      console.log(`âœ“ Äá»c ChÆ°Æ¡ng ${i}: ${chapterName}`);
    } else {
      console.log(`âœ— KhÃ´ng tÃ¬m tháº¥y file C${i}.txt`);
    }
  }

  return chapters;
}

// Escape string cho TypeScript
function escapeForTS(str) {
  return str.replace(/\\/g, "\\\\").replace(/`/g, "\\`").replace(/\$/g, "\\$");
}

// Generate file TypeScript
function generateTSFile(chapters) {
  let output = `// Auto-generated file - DO NOT EDIT MANUALLY
// Generated by: node scripts/generate-qtda-chapters.cjs
// Generated at: ${new Date().toISOString()}

export interface QTDAChapter {
  id: number;
  name: string;
  shortName: string;
  content: string;
}

export const QTDA_CHAPTERS: QTDAChapter[] = [
`;

  for (const chapter of chapters) {
    output += `  {
    id: ${chapter.id},
    name: "${escapeForTS(chapter.name)}",
    shortName: "${escapeForTS(chapter.shortName)}",
    content: \`${escapeForTS(chapter.content)}\`
  },
`;
  }

  output += `];

// Helper function Ä‘á»ƒ láº¥y random chÆ°Æ¡ng
export function getRandomChapters(count: number = 1): QTDAChapter[] {
  const shuffled = [...QTDA_CHAPTERS].sort(() => Math.random() - 0.5);
  return shuffled.slice(0, Math.min(count, QTDA_CHAPTERS.length));
}

// Helper function Ä‘á»ƒ láº¥y chÆ°Æ¡ng theo ID
export function getChapterById(id: number): QTDAChapter | undefined {
  return QTDA_CHAPTERS.find(c => c.id === id);
}

// Láº¥y danh sÃ¡ch tÃªn cÃ¡c chÆ°Æ¡ng
export function getChapterNames(): { id: number; name: string }[] {
  return QTDA_CHAPTERS.map(c => ({ id: c.id, name: c.name }));
}
`;

  return output;
}

// Main
function main() {
  console.log("ğŸš€ Báº¯t Ä‘áº§u generate QTDA chapters...\n");

  const chapters = readChapterFiles();

  if (chapters.length === 0) {
    console.error("âŒ KhÃ´ng tÃ¬m tháº¥y file chÆ°Æ¡ng nÃ o!");
    process.exit(1);
  }

  console.log(`\nğŸ“š ÄÃ£ Ä‘á»c ${chapters.length} chÆ°Æ¡ng`);

  const tsContent = generateTSFile(chapters);

  // Táº¡o thÆ° má»¥c náº¿u chÆ°a cÃ³
  const outputDir = path.dirname(OUTPUT_FILE);
  if (!fs.existsSync(outputDir)) {
    fs.mkdirSync(outputDir, { recursive: true });
  }

  fs.writeFileSync(OUTPUT_FILE, tsContent, "utf-8");

  console.log(`\nâœ… ÄÃ£ táº¡o file: ${OUTPUT_FILE}`);
  console.log(
    `ğŸ“¦ KÃ­ch thÆ°á»›c: ${(fs.statSync(OUTPUT_FILE).size / 1024).toFixed(2)} KB`
  );
}

main();
